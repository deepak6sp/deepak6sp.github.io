<!DOCTYPE html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7"><![endif]-->
<!--[if IE 7]><html class="no-js lt-ie9 lt-ie8" <![endif]-->
<!--[if IE 8]><html class="no-js lt-ie9" <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->

<meta charset="utf-8" />
<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<!--Import Google Icon Font-->
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/css/materialize.min.css">

<link rel="stylesheet" href="/assets/css/main.css">

<body>
  <!-- Always shows a header, even in smaller screens. -->
<nav class="light-blue darken-4">
  <div class="nav-wrapper container">
    <a href="/" class="brand-logo">Deepak Prakash</a>
    <ul class="right">
      
          <li><a href="/about">About</a></li>
      
    </ul>

    <ul class="side-nav" id="slide-out">
      <h5>Categories</h5>
      
      
        
        <li><a class="waves-effect waves-light-blue" href="/categories/BuildTools.html">Buildtools</a></li>
      
        
        <li><a class="waves-effect waves-light-blue" href="/categories/DevOps.html">Devops</a></li>
      
        
        <li><a class="waves-effect waves-light-blue" href="/categories/Development.html">Development</a></li>
      
        
        <li><a class="waves-effect waves-light-blue" href="/categories/Git.html">Git</a></li>
      
        
        <li><a class="waves-effect waves-light-blue" href="/categories/Testing.html">Testing</a></li>
      
    </ul>
    <a href="#" data-activates="slide-out" class="button-collapse"><i class="material-icons">menu</i></a>
  </div>
</nav>

  <main class="page-content container">
    <div class="post">
  <h4 class="postTitle">How to wait for promises during unit test</h4>
  <h6 class="text-success">
    26 Feb 2017
  </h6>
  <div class="row">
  <div class="col s2 m1">
    <a class="twitter-share-button"
      href="https://twitter.com/intent/tweet?text=How to wait for promises during unit test https://deepak6sp.github.io/testing/2017/02/26/Unit-Testing-Promises.html">
    </a>
  </div>
  <div class="col s2 m1">
    <script src="https://platform.linkedin.com/in.js" type="text/javascript"> lang: en_US</script>
    <script type="IN/Share" data-url="https://deepak6sp.github.io/testing/2017/02/26/Unit-Testing-Promises.html" data-counter="right"></script>
  </div>
</div>

  <p>Assume you are testing a Javascript method which calls a url and, then that url
returns a promise with ‘SOME VALUE’.</p>

<p><strong>test-function.js</strong></p>
<pre>
export class TestClass {
  constructor(){
  }
  testMethod(){
    var promise = fetch(url)
    .then((response) =&gt; {
      return response;
    });
  }
}
</pre>

<p>Lets start writing test. I will be using Jasmine to write unit tests.
Firstly, we will write test to make sure the function has been defined.
A simple test could be,</p>
<pre>
import { TestClass }  from ‘test-function.js’;
describe ( ‘check function’ , () =&gt; {
  it(‘has been defined, () =&gt;  {
    expect(TestClass.testMethod).toBeDefined();
  }
});
</pre>

<p>This will fail because, we have not initiated the class instance.
So, we will do this in beforeAll()</p>

<pre>
import { TestClass }  from ‘test-function.js’;
describe ( ‘check testMethod()’ , () =&gt; {
  let testClass;
  beforeAll(() =&gt; {
    testClass = new TestClass();
  });

  it(‘has been defined, () =&gt;  {
    expect(testClass.testMethod).toBeDefined();
  }
});
</pre>

<p>Next, we will call the url using javascript fetch API. But, this time we will initiate the class instance when promise is returned. Then, we will also write test to check if promise is returned.</p>

<pre>
import { TestClass }  from ‘test-function.js’;
describe ('check testMethod()', () =&gt; {
  let testClass;
  let newPromise;
  beforeAll(() =&gt; {
    newPromise =  fetch(url)
      .then(response =&gt; response.json())
      .then(value =&gt; {
        testClass = new TestClass(value);
      });
  });

  it('has been defined', () =&gt;  {
    expect(testClass.testMethod).toBeDefined();
  }

  it('returns a promise', () =&gt; {
    expect(newPromise).toEqual(jasmine.any(Promise));
  });

  it('is returning correct value' , () =&gt; {
    expect(testClass.testMethod).toEqual(SOME VALUE);
  });
});
</pre>
<p>When you run test, the first and second test case will pass, however,
the third test case will fail.</p>

<p><b>What went wrong?</b><br />
The third test was executed before the promise was actually returned. So, how to fix it.
The solution is we need to wait for the promise to return before executing the second test.</p>
<pre>
beforeEach(done =&gt; {
  returnPromise.then(() =&gt; {
    done();
  });
});
</pre>
<p>So , the test looks as below</p>
<pre>
import { TestClass }  from ‘test-function.js’;
describe ( ‘check testMethod()’ , () =&gt; {
  let testClass;
  let Promise;
  beforeAll(() =&gt; {
    newPromise =  fetch(url)
    .then(response =&gt; response.json())
    .then(value =&gt; {
      testClass = new TestClass(value);
    });
  });

  it('has been defined', () =&gt;  {
    expect(testClass.testMethod). toBeDefined();
  });

  it('returns a promise', () =&gt; {
    expect(newPromise).toEqual(jasmine.any(Promise));
  });

  describe('on successful promise return : ', () =&gt; {
    beforeEach(done =&gt; {
      newPromise.then(() =&gt; {
      done();
    });

    it('is returning correct value', () =&gt; {
      expect(testClass.testMethod).toEqual(SOME VALUE);
    });
  });
});
</pre>

<p>Now, all the test cases should pass.</p>

  </br>

</div>

  </main><!-- end .content -->
  <footer class="page-footer light-blue darken-4">
  <div class="footer-copyright">
    <div class="container">
      Written with ♡
      <div class="grey-text text-lighten-4 right">
        © 2017 Deepak Prakash
      </div>
    </div>
  </div>
</footer>

  <!--Import jQuery before materialize.js-->
<script type="text/javascript" src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.98.0/js/materialize.min.js"></script>

<script>
$(document).ready(function(){
  $(".button-collapse").sideNav({
    menuWidth: 200, // Default is 300
    closeOnClick: true, // Closes side-nav on <a> clicks, useful for Angular/Meteor
  });

  // smooth scrolling
  $(document).on('click', 'a.smooth-scroll', function(event){
      event.preventDefault();

      $('html, body').animate({
          scrollTop: $( $.attr(this, 'href') ).offset().top
      }, 500);
  });

})
</script>


<!-- facebook script -->
<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_GB/sdk.js#xfbml=1&version=v2.8";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>

<!-- twitter script -->
<script>window.twttr = (function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0],
    t = window.twttr || {};
  if (d.getElementById(id)) return t;
  js = d.createElement(s);
  js.id = id;
  js.src = "https://platform.twitter.com/widgets.js";
  fjs.parentNode.insertBefore(js, fjs);

  t._e = [];
  t.ready = function(f) {
    t._e.push(f);
  };

  return t;
}(document, "script", "twitter-wjs"));</script>

</body>
</html>
